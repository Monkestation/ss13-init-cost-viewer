<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>SS13 Init Log Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: #272727;
      font-size: 12px;
      color: #ffffff;
      line-height: 170%;
    }

    hr {
      background-color: #40628a;
      height: 2px;
      border: 0;
    }

    a,
    button,
    a:link,
    a:visited,
    a:active,
    .linkOn,
    .linkOff {
      color: #ffffff;
      text-decoration: none;
      background: #40628a;
      border: 1px solid #161616;
      padding: 1px 4px 1px 4px;
      margin: 0 2px 0 0;
      cursor: default;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    a:hover {
      color: #40628a;
      background: #ffffff;
    }

    a.inlineblock {
      display: inline-block;
    }

    a.white,
    a.white:link,
    a.white:visited,
    a.white:active {
      color: #40628a;
      text-decoration: none;
      background: #ffffff;
      border: 1px solid #161616;
      padding: 1px 4px 1px 4px;
      margin: 0 2px 0 0;
      cursor: default;
    }

    a.white:hover {
      color: #ffffff;
      background: #40628a;
    }

    .linkOn,
    a.linkOn:link,
    a.linkOn:visited,
    a.linkOn:active,
    a.linkOn:hover {
      color: #ffffff;
      background: #2f943c;
      border-color: #24722e;
    }

    .linkOff,
    a.linkOff:link,
    a.linkOff:visited,
    a.linkOff:active,
    a.linkOff:hover {
      color: #ffffff;
      background: #999999;
      border-color: #666666;
    }

    a.icon,
    .linkOn.icon,
    .linkOff.icon {
      position: relative;
      padding: 1px 4px 2px 20px;
    }

    a.icon img,
    .linkOn.icon img {
      position: absolute;
      top: 0;
      left: 0;
      width: 18px;
      height: 18px;
    }

    ul {
      padding: 4px 0 0 10px;
      margin: 0;
      list-style-type: none;
    }

    li {
      padding: 0 0 2px 0;
    }

    img,
    a img {
      border-style: none;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin: 0;
      padding: 2px 0 4px 0;
      color: #517087;
    }

    h1 {
      font-size: 15px;
    }

    h2 {
      font-size: 14px;
    }

    h3 {
      font-size: 13px;
    }

    h4 {
      font-size: 12px;
    }

    .uiWrapper {
      width: 100%;
      height: 100%;
    }

    .uiTitle {
      clear: both;
      padding: 6px 8px 6px 8px;
      border-bottom: 2px solid #161616;
      background: #383838;
      color: #98b0c3;
      font-size: 16px;
    }

    .uiTitle.icon {
      padding: 6px 8px 6px 42px;
      background-position: 2px 50%;
      background-repeat: no-repeat;
    }

    .uiContent {
      clear: both;
      padding: 8px;
      font-family: Verdana, Geneva, sans-serif;
    }
    .block {
      padding: 8px;
      margin: 10px 4px 4px 4px;
      border: 1px solid #40628a;
      background-color: #202020;
    }

    .tree-node {
      margin-left: 20px;
      /* margin-top: 5px; */
    }
    .tree-item {
      cursor: pointer;
      /* padding: 3px 5px; */
      border-radius: 3px;
    }
    .tree-item:hover {
      background: #2d2d30;
    }
    .cost-high {
      color: #f48771;
      font-weight: bold;
    }
    .cost-med {
      color: #dcdcaa;
    }
    .cost-low {
      color: #4ec9b0;
    }
    .expander {
      display: inline-block;
      width: 15px;
    }
    .percentage {
      color: #858585;
      font-size: 0.9em;
    }
    .count {
      color: #9cdcfe;
      font-size: 0.9em;
    }
    .avg {
      color: #ce9178;
      font-size: 0.9em;
    }
    .summary {
      background: #252526;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .controls {
      background: #252526;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    /* .controls button {
        background: #0e639c;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 3px;
        cursor: pointer;
        margin-right: 10px;
      } */
    /* .controls button:hover {
        background: #1177bb;
      }
      .controls button.active {
        background: #1177bb;
      } */
    .tab-group {
      display: inline-block;
      /* margin-right: 20px; */
    }
    a,
    button,
    a:link,
    a:visited,
    a:active,
    .linkOn,
    .linkOff {
      color: #ffffff;
      text-decoration: none;
      background: #40628a;
      border: 1px solid #161616;
      padding: 1px 4px 1px 4px;
      margin: 0 2px 0 0;
      cursor: default;
      font-family: monospace;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    a:hover {
      color: #40628a;
      background: #ffffff;
    }

    a.white,
    a.white:link,
    a.white:visited,
    a.white:active {
      color: #40628a;
      text-decoration: none;
      background: #ffffff;
      border: 1px solid #161616;
      padding: 1px 4px 1px 4px;
      margin: 0 2px 0 0;
      cursor: default;
    }

    a.white:hover {
      color: #ffffff;
      background: #40628a;
    }

    .linkOn,
    a.linkOn:link,
    a.linkOn:visited,
    a.linkOn:active,
    a.linkOn:hover {
      color: #ffffff;
      background: #2f943c;
      border-color: #24722e;
    }

    .linkOff,
    a.linkOff:link,
    a.linkOff:visited,
    a.linkOff:active,
    a.linkOff:hover {
      color: #ffffff;
      background: #999999;
      border-color: #666666;
    }

    .statusDisplay {
      background: #000000;
      color: #ffffff;
      border: 1px solid #40628a;
      padding: 4px;
      margin: 3px 0;
    }

    .statusLabel,
    .statusDisplay b {
      width: 128px;
      float: left;
      overflow: hidden;
      color: #98b0c3;
    }

    .statusValue {
      float: left;
    }

    .runtime {
      background-color: #171717;
      border: solid 1px #202020;
      font-family: "Courier New";
      padding: 10px;
      color: #cccccc;
      display: grid;
    }
  </style>
  <body>
    <div class="uiTitleWrapper">
      <div class="uiTitle">
        <tt>SS13 JSON Log Viewer</tt> |
        <span style="font-family: Verdana, Geneva, Tahoma, sans-serif; font-size: 12px">
          <a href="https://github.com/Monkestation/Monkestation2.0/pull/9444" target="_blank" rel="noopener noreferrer"
            >Game Code</a
          >
          |
          <a href="https://github.com/monkestation/ss13-init-cost-viewer/" target="_blank" rel="noopener noreferrer"
            >Repository</a
          >
          <!-- TODO: add modal code for a readme -->
          <!-- |
          <a href="#">?</a> -->
        </span>
      </div>
    </div>

    <!-- <input type="button" value="Export JSON" onclick="exportJSON()" />
    <script>
      function exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.DATA));
        const dlAnchorElem = document.createElement("a");
        dlAnchorElem.setAttribute("href", dataStr);
        dlAnchorElem.setAttribute("download", "init_costs_[MODE].json");
        document.body.appendChild(dlAnchorElem);
        dlAnchorElem.click();
        dlAnchorElem.remove();
      }
    </script>
    <a
      onclick="window.location.href = 'byond:\/\/?action=openLink&link=' + encodeURIComponent('https:\/\/monkestation.github.io/ss13-init-cost-viewer/');"
      href="#"
      >Website version</a
    > -->
    <div class="uiContent">
      <input type="file" id="fileInput" style="display: none" accept="application/json" />
      <a onclick='document.getElementById("fileInput").click();'>Load Init Log File</a>
      <a onclick='loadExampleFile();' alt="Load example file" title="Load example file">(?)</a>

      <script>
        document.getElementById("fileInput").addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);
              if (!data.init || !data.late) {
                alert("Invalid file format: missing 'init' or 'late' sections.");
                return;
              }
              window.DATA = data;
              renderAll();
            } catch (err) {
              alert("Error parsing JSON: " + err.message);
            }
          };
          reader.readAsText(file);
        });

        function loadExampleFile() {
          fetch("init_costs_example_1762772978248.json")
            .then((response) => response.json())
            .then((exampleData) => {
              window.DATA = exampleData;
              renderAll();
            })
            .catch((error) => {
              alert("Error loading example file: " + error.message);
            });
        }
      </script>
      <div>
        <div class="tab-group">
          <a id="btn_init" onclick='setMode("init")'>Initialize()</a>
          <a id="btn_late" onclick='setMode("late")'>LateInitialize()</a> |
        </div>
        <div class="tab-group">
          <a id="btn_total" onclick='setSort("total")'>Sort by Total Time</a>
          <a id="btn_avg" onclick='setSort("avg")'>Sort by Average Time</a>
        </div>
      </div>
      <hr />

      <div id="mainContent" style="display: none;">
        <div id="summary" class="statusDisplay"></div>
        <div id="tree_root" class="runtime"></div>
      </div>
    </div>

    <script>
      let MODE = "init"; // 'init' or 'late'
      let SORT = "total"; // 'total' or 'avg'

      function buildTree(flat) {
        const root = {};
        for (const path in flat) {
          const entry = flat[path];
          const parts = path.split("/").filter(Boolean);
          let node = root;
          let built = "";
          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            built += (built ? "/" : "") + part;
            if (!node[part]) {
              node[part] = {
                cost: 0,
                count: 0,
                direct_cost: 0,
                direct_count: 0,
                children: {},
                path: built,
                is_leaf: i === parts.length - 1,
              };
            }
            if (i === parts.length - 1) {
              node[part].direct_cost = entry.cost || 0;
              node[part].direct_count = entry.count || 0;
            }
            node[part].cost += entry.cost || 0;
            node[part].count += entry.count || 0;
            node = node[part].children;
          }
        }
        return root;
      }

      function formatNumber(n) {
        return Math.round(n * 1000) / 1000;
      }
      function clearChildren(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function sortedKeys(tree, sortByAvg, totalCost) {
        const keys = Object.keys(tree);
        keys.sort((a, b) => {
          const n1 = tree[a],
            n2 = tree[b];
          const v1 = sortByAvg ? n1.cost / Math.max(n1.count, 1) : n1.cost;
          const v2 = sortByAvg ? n2.cost / Math.max(n2.count, 1) : n2.cost;
          return v2 - v1; // descending
        });
        return keys;
      }

      let idCounter = 0;
      function renderTree(tree, container, totalCost, sortByAvg) {
        const keys = sortedKeys(tree, sortByAvg, totalCost);
        for (const key of keys) {
          const node = tree[key];
          const cost = node.cost;
          const count = node.count;
          const direct_cost = node.direct_cost;
          const direct_count = node.direct_count;
          const avg_cost = formatNumber(cost / Math.max(count, 1));
          const percentage = totalCost > 0 ? formatNumber((cost / totalCost) * 100) : 0;
          idCounter++;
          const myId = "node" + idCounter;
          const hasChildren = Object.keys(node.children).length > 0;
          let costClass = "cost-low";
          if (percentage >= 10) costClass = "cost-high";
          else if (percentage >= 1) costClass = "cost-med";

          const item = document.createElement("div");
          item.className = "tree-item";

          const exp = document.createElement("span");
          exp.className = "expander";
          exp.id = "exp_" + myId;
          exp.textContent = hasChildren ? "▼" : "\u00A0";
          if (hasChildren) exp.style.cursor = "pointer";
          item.appendChild(exp);

          const nameSpan = document.createElement("span");
          nameSpan.className = costClass;
          nameSpan.textContent = key;
          item.appendChild(nameSpan);

          const info = document.createElement("span");
          info.innerHTML =
            " - <b>" +
            cost +
            'ds</b> <span class="count">(' +
            count +
            'x)</span> <span class="avg">' +
            avg_cost +
            "ds avg</span>";
          if (direct_cost > 0 && hasChildren) {
            const directAvg = formatNumber(direct_cost / Math.max(direct_count, 1));
            info.innerHTML += " (direct: " + direct_cost + "ds, " + direct_count + "x, " + directAvg + "ds avg) ";
          }
          info.innerHTML += ' <span class="percentage">(' + percentage + "%)</span>";
          item.appendChild(info);

          container.appendChild(item);

          if (hasChildren) {
            const childContainer = document.createElement("div");
            childContainer.className = "tree-node";
            childContainer.id = myId;
            container.appendChild(childContainer);
            // by default children are visible; toggle handler
            exp.addEventListener("click", () => {
              if (childContainer.style.display === "none") {
                childContainer.style.display = "block";
                exp.textContent = "▼";
              } else {
                childContainer.style.display = "none";
                exp.textContent = "▶";
              }
            });
            renderTree(node.children, childContainer, totalCost, sortByAvg);
          }
        }
      }

      function renderAll() {
        const flat = MODE === "init" ? window.DATA.init : window.DATA.late;
        const tree = buildTree(flat);
        // compute totals
        let totalCost = 0,
          totalCount = 0,
          types = 0;
        for (const k in flat) {
          totalCost += flat[k].cost || 0;
          totalCount += flat[k].count || 0;
          types++;
        }

        const summary = document.getElementById("summary");
        summary.innerHTML =
          "<h2>" +
          (MODE === "late" ? "Late " : "") +
          "Initialization Cost Analysis</h2>" +
          "<b>Total " +
          (MODE === "late" ? "Late " : "") +
          "Init Time:</b> " +
          totalCost +
          " ds (" +
          formatNumber(totalCost / 10) +
          "s)<br>" +
          "<b>Total Instances:</b> " +
          totalCount +
          "<br>" +
          "<b>Total Types:</b> " +
          types +
          "<br>" +
          "<b>Average Cost:</b> " +
          totalCost / Math.max(totalCount, 1) +
          " ds per instance<br>" +
          "<b>Sorting by:</b> " +
          (SORT === "avg" ? "Average time per instance" : "Total time");

        const root = document.getElementById("tree_root");
        clearChildren(root);
        idCounter = 0;
        renderTree(tree, root, totalCost, SORT === "avg");
        // update buttons classes
        document.getElementById("btn_init").className = MODE === "init" ? "active" : "";
        document.getElementById("btn_late").className = MODE === "late" ? "active" : "";
        document.getElementById("btn_total").className = SORT === "total" ? "active" : "";
        document.getElementById("btn_avg").className = SORT === "avg" ? "active" : "";

        document.getElementById("mainContent").style.display = "block";
      }

      function setMode(m) {
        if (MODE === m) return;
        MODE = m;
        renderAll();
      }
      function setSort(s) {
        if (SORT === s) return;
        SORT = s;
        renderAll();
      }
    </script>
  </body>
</html>
